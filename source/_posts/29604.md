---
title: "*saltstack grains 示例"
date: 2017-07-06 08:00:00
updated: 2017-07-07 14:12:04
tags: ["Python","运维","Saltstack"]
---
{% raw %}
<p>GRAINS 组件是saltstack中非常重要的一个组件，其主要用于记录Minion的一些静态信息，如比：CPU、内存、磁盘、网络等。grains信息是每次客户端启动后自动上报给master的，一旦这些静态信息发生改变需要重启minion 或者 重新同步下 grains。除此之外我们还可以自定义Grains的一些信息。自定义的方法有三种：1、通过Minion配置文件定义；2、通过Grains相关模块定义；3、通过python脚本定义。</p><p><br/></p><p>1.查看Grains相关的命令及用法(sys.list_functions or sys.doc) salt &#39;*&#39; sys.list_functions grains</p><p><img src="/uploads/ueditor/php/upload/image/20170706/1499305756.png" title="1499305756.png" alt="blob.png"/></p><p>2.获取主机item信息(grains.ls or grains.items) salt &#39;*&#39; grains.items</p><p><img src="/uploads/ueditor/php/upload/image/20170706/1499305728.png" title="1499305728.png" alt="blob.png"/></p><p>3.根据Grains的分组应用,筛选win系统&nbsp;salt -G &#39;os:Windows&#39; &nbsp;test.ping</p><p><img src="/uploads/ueditor/php/upload/image/20170706/1499305854.png" title="1499305854.png" alt="blob.png"/></p><p>4.通过Grains模块定义Grains</p><p><img src="/uploads/ueditor/php/upload/image/20170706/1499305927.png" title="1499305927.png" alt="blob.png"/></p><p>5.使用自定义python脚本获取grains信息 - 获取主机系统时间</p><p><br/></p><p>默认自定义脚本需要存放在master的/srv/salt/_grains目录下，这里使用mkdir -p创建即可。这里一个获取系统时间的脚本内容如下：</p><p><br/></p><p>[root@saltmaster _grains]# cat get_time.py</p><p>#!/usr/bin/env python</p><p># coding=utf-8</p><p>from datetime import datetime</p><p>def get_server_time():</p><p>&nbsp; &nbsp; grains = {}</p><p>&nbsp; &nbsp; grains[&#39;server_time&#39;] = datetime.now().strftime(&#39;%Y-%m-%d %H:%M:%S&#39;)</p><p>&nbsp; &nbsp; return grains</p><p>使用sync_grains命令同步脚本到minion主机上去，并通过grains.item命令获取相关信息即可，如下：</p><p><br/></p><p>[root@saltmaster _grains]# salt &#39;*&#39; saltutil.sync_grains</p><p>serverb.pod0.example.com:</p><p>&nbsp; &nbsp; - grains.get_time</p><p>irora200:</p><p>&nbsp; &nbsp; - grains.get_time</p><p>[root@saltmaster _grains]# salt &#39;*&#39; grains.item server_time</p><p>serverb.pod0.example.com:</p><p>&nbsp; &nbsp; ----------</p><p>&nbsp; &nbsp; server_time:</p><p>&nbsp; &nbsp; &nbsp; &nbsp; 2014-04-02 23:53:23</p><p>irora200:</p><p>&nbsp; &nbsp; ----------</p><p>&nbsp; &nbsp; server_time:</p><p>&nbsp; &nbsp; &nbsp; &nbsp; 2014-04-02 15:53:23</p><p>执行同步命令后，自定义脚本会上传到minion的/var/cache/salt/minion/extmods/grains目录下。</p><p><br/></p><p>[root@irora200 grains]# ls</p><p>get_time.py &nbsp;get_time.pyc</p><p>[root@irora200 grains]# pwd</p><p>/var/cache/salt/minion/extmods/grains</p><p><br/></p><p><br/></p><p>进阶: 使用grains搭建自动监控工具&nbsp;<a href="http://rfyiamcool.blog.51cto.com/1030776/1266437/" _src="http://rfyiamcool.blog.51cto.com/1030776/1266437/">http://rfyiamcool.blog.51cto.com/1030776/1266437/</a>&nbsp;</p>
{% endraw %}
